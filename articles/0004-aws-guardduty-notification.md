---
title: "GuardDuty„ÅÆËÑÖÂ®ÅÊ§úÂá∫ÁµêÊûú„ÇíSlack/Teams„Å´ÈÄöÁü•„Åô„Çã"
emoji: "üê≥"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["aws", "guardduty", "lambda", "cloudformation"]
published: false
---
# Âàù„ÇÅ„Å´
ÁîüÁî£ÊäÄË°ìÈÉ®„ÅßË£ΩÂìÅ„ÅÆÊ§úÊüªÂ∑•Á®ã„ÇíÊãÖÂΩì„Åó„Å¶„ÅÑ„Çã„Ç®„É≥„Ç∏„Éã„Ç¢„Åß„Åô„ÄÇAWS„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂØæÂøú„ÅÆ„Åü„ÇÅ„ÄÅGuardDuty„ÇíÂà©Áî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇGuardDuty„ÇíÂà©Áî®„Åô„Çã„Åì„Å®„Åß„ÄÅÊÇ™ÊÑè„ÅÆ„ÅÇ„Çã„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÇÑÁï∞Â∏∏„Å™Âãï‰Ωú„ÇíÁ∂ôÁ∂öÁöÑ„Å´„É¢„Éã„Çø„É™„É≥„Ç∞„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Åó„Åã„Åó„ÄÅÊ§úÁü•„Åó„ÅüÁµêÊûú„Å´Ê∞ó„Åå‰ªò„Åã„Å™„Åë„Çå„Å∞ÊÑèÂë≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÉÅ„É£„ÉÉ„Éà„ÉÑ„Éº„É´„Å´ÁµêÊûú„ÇíËª¢ÈÄÅ„Åô„Çã„Åì„Å®„Åß„ÄÅÊó©ÊÄ•„Å™ÂØæÂøú„Åå„Åß„Åç„Çã‰ΩìÂà∂„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ

# Slack/Teams„Å∏„ÅÆÈÄöÁü•ÊñπÊ≥ï
ËÑÖÂ®Å„ÇíÊ§úÁü•„Åó„ÅüÁµêÊûú„ÅØ„ÄÅËá™ÂãïÁöÑ„Å´EventBridge(ÊóßAmazon CloudWatch Events)„Å´ÈÄÅ‰ø°„Åï„Çå„Çã„Åü„ÇÅ„ÄÅEventBridge„Åß„Ç§„Éô„É≥„Éà„Çí„Éà„É™„Ç¨„Åó„ÄÅSNS„Å´Ëª¢ÈÄÅ„Åó„Åæ„Åô„ÄÇ

* Slack„ÇíÂà©Áî®„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅChatbot„Å®„ÅÆÈÄ£Êê∫„ÅåÂèØËÉΩ„Å™„Åü„ÇÅ„ÄÅChatbot„ÇíSNS„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„Å´„Åó„Åæ„Åô„ÄÇ
* Teams„ÇíÂà©Áî®„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅLambda„ÇíSNS„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Åó„ÄÅLambda„ÅßÁµêÊûú„ÇíÂä†Â∑•„Åó„Å¶Incoming Webhook„ÅßTeams„Å´Ëª¢ÈÄÅ„Åó„Åæ„Åô„ÄÇ

![](/images/article-0004/guardduty-notification.png)

# Slack„ÇíÂà©Áî®„Åô„ÇãÂ†¥Âêà„ÅÆCloudformation
GuardDuty„ÅØCloudTrail„ÄÅKubernetes„ÄÅVPC„Éï„É≠„Éº„É≠„Ç∞„ÄÅDNS„É≠„Ç∞Á≠â„Çí„ÇÇ„Å®„Å´ËÑÖÂ®ÅÊ§úÁü•„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ„Åü„Å†„Åó„ÄÅ„Åì„Çå„Çâ„ÅÆË®≠ÂÆö„ÅØ‰∏çË¶Å„Åß„ÅÇ„Çä„ÄÅGuardDuty„ÅØÊúâÂäπ„Å´„Åô„Çã„Å†„Åë„Åß„ÄÅËÑÖÂ®ÅÊ§úÁü•„ÅåËá™ÂãïÁöÑ„Å´ÈñãÂßã„Åï„Çå„Åæ„Åô„ÄÇEventBridge„ÅØ„ÄÅ‰ª•‰∏ã„Å´Ë®òËºâ„Åï„Çå„Å¶„ÅÑ„Çã„Ç§„Éô„É≥„Éà„ÅÆ„É´„Éº„É´„ÇíË®≠ÂÆö„Åó„ÄÅTarget„Å´SNS„ÅÆ„Éà„Éî„ÉÉ„ÇØ„ÇíÊåáÂÆö„Åó„Åæ„Åô„ÄÇ

https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/guardduty_findings_cloudwatch.html

SNS„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å´„ÅØChatbot„ÅÆAPI `https://global.sns-api.chatbot.amazonaws.com` „ÇíÊåáÂÆö„Åó„Åæ„Åô„ÄÇChatBot„ÅØ‰∫à„ÇÅ„ÄÅAWS„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„ÄÅSlack„Å®ÈÄ£Êê∫„Åó„Å¶„Åä„Åç„Åæ„Åô„ÄÇCloudformation„ÅÆChatBot„Å´„ÅØ„ÄÅSnsTopicArns„Å´SNS„Éà„Éî„ÉÉ„ÇØ„ÅÆARN„ÇíÊåáÂÆö„Åó„ÄÅSlackChannelId„Å®SlackWorkspaceId„ÇíÊåáÂÆö„Åô„Çã„Åì„Å®„Åß„ÄÅÈÄöÁü•„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇSlackChannelId„ÅØ„ÄÅÂØæË±°„ÅÆSlack„ÉÅ„É£„É≥„Éç„É´„ÇíÂè≥„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅ„Äå„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ„Ç≥„Éî„Éº„Åó„ÅüURL„ÅÆÊúÄÂæå„ÅÆ„Çπ„É©„ÉÉ„Ç∑„É•‰ª•Èôç„ÅÆÊñáÂ≠óÂàó„ÅåÂØæË±°„ÅÆId„Å´„Å™„Çä„Åæ„Åô„ÄÇ

`https://sample.slack.com/archives/XXXXXXXXXXX`

SlackWorkspaceId„ÅØ„ÄÅChatBot„ÅÆAWS„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„ÄåÁµêÊûú„Çµ„É≥„Éó„É´„ÅÆÁîüÊàê„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åì„Å®„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ„Åì„Çå„Çâ„ÅÆId„ÅØ„Éë„É©„É°„Éº„Çø„Çπ„Éà„Ç¢„Å´‰øùÂ≠ò„Åó„ÄÅË™≠„ÅøËæº„Çì„Åß‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: Guard Duty
# ------------------------------------------------------------------------------
# Resources
# ------------------------------------------------------------------------------
Resources:
  GuardDuty:
    Type: AWS::GuardDuty::Detector
    Properties:
      Enable: True
      FindingPublishingFrequency: FIFTEEN_MINUTES
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: guardduty notification
      Name: guardduty-notification
      EventPattern:
        source:
          - aws.guardduty
        detail-type:
          - GuardDuty Finding
      State: ENABLED
      Targets:
        - Arn: !Ref Topic
          Id: sns-topic
  Topic:
    Type: AWS::SNS::Topic
  Subscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: https
      TopicArn: !Ref Topic
      Endpoint: "https://global.sns-api.chatbot.amazonaws.com"
  ChatBot:
    Type: AWS::Chatbot::SlackChannelConfiguration
    Properties:
      ConfigurationName: GuardDutyNotification
      IamRoleArn: !GetAtt ChatBotRole.Arn
      LoggingLevel: NONE
      SlackChannelId: "{{resolve:ssm:GuardDutySlackChannelId:1}}"
      SlackWorkspaceId: "{{resolve:ssm:GuardDutySlackWorkspaceId:1}}"
      SnsTopicArns:
        - !Ref Topic
      UserRoleRequired: false
  ChatBotRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: chatbot.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSSupportAccess
        - arn:aws:iam::aws:policy/AWSIncidentManagerResolverAccess
```

# Slack„Å∏„ÅÆÈÄöÁü•„ÅÆÁ¢∫Ë™ç
Chatbot„Å®SlackÈñì„ÅÆÁñéÈÄö„ÅØ„ÄÅChatbot„ÅÆAWS„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„ÄÅ„Äå„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åì„Å®„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇSlack„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/article-0004/chatbot-test.png)

GuardDuty„Åã„ÇâSlack„Åæ„Åß„ÅÆÁñéÈÄö„ÅØGuardDuty„ÅÆAWS„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„ÄåÁµêÊûú„Çµ„É≥„Éó„É´„ÇíÁîüÊàê„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åì„Å®„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇSlack„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/article-0004/guardduty-to-slack.png)

# Teams„ÇíÂà©Áî®„Åô„ÇãÂ†¥Âêà„ÅÆCloudformation
Slack„Å∏ÈÄöÁü•„Åô„ÇãÂ†¥Âêà„Å®„ÅÆÈÅï„ÅÑ„ÅØ„ÄÅEventBridge„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„Çí„ÄÅLambda„Å´Ë®≠ÂÆö„Åô„Çã„Å®„Åì„Çç„Åß„Åô„ÄÇ

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: Guard Duty
# ------------------------------------------------------------------------------
# Resources
# ------------------------------------------------------------------------------
Resources:
  GuardDuty:
    Type: AWS::GuardDuty::Detector
    Properties:
      Enable: True
      FindingPublishingFrequency: FIFTEEN_MINUTES
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: guardduty notification
      Name: guardduty-notification
      EventPattern:
        source:
          - aws.guardduty
        detail-type:
          - GuardDuty Finding
      State: ENABLED
      Targets:
        - Arn: !GetAtt Function.Arn
          Id: lambda
  EventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref Function
      Principal: events.amazonaws.com
      SourceAccount: !Ref AWS::AccountId
      SourceArn: !GetAtt EventRule.Arn
  Function:
    Type: AWS::Lambda::Function
    Properties:
      Handler: guardduty-notification
      Role: !GetAtt LambdaRole.Arn
      Code:
        S3Bucket: lambda-m090d3wnw8nug47yfdcw3-artifact
        S3Key: guardduty-notification.zip
      Runtime: go1.x
      ReservedConcurrentExecutions: 1
      Timeout: 5
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          TeamsUrl: "{{resolve:ssm:TeamsUrl:1}}"
  LambdaRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Condition: {}
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: f-iot.service.name
          Value: lambda
    Type: AWS::IAM::Role
```

# Teams„ÇíÂà©Áî®„Åô„ÇãÂ†¥Âêà„ÅÆLambda
EventBridge„Åã„ÇâÂèó„ÅëÂèñ„Å£„Åü„Ç§„Éô„É≥„Éà„ÇíÂä†Â∑•„Åó„ÄÅÂøÖË¶Å„Å™ÊÉÖÂ†±„ÇíÁí∞Â¢ÉÂ§âÊï∞„Åã„ÇâË™≠„ÅøËæº„Çì„Å†TeamsUrl„Å´ÂØæ„Åó„Å¶„ÄÅÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ

```go
// main GuardDuty„ÅåÊ§úÁü•„Åó„ÅüÁï∞Â∏∏„ÇíÈÄöÁü•„Åó„Åæ„Åô„ÄÇ
package main

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"strconv"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

type GuardDutyEvent struct {
	Severity    string `json:"severity"`
	AccountId   string `json:"accountId"`
	Id          string `json:"id"`
	Type        string `json:"type"`
	Region      string `json:"region"`
	Description string `json:"description"`
}

type Fact struct {
	Name  string `json:"name"`
	Value string `json:"value"`
}

type Section struct {
	Facts []Fact `json:"facts"`
}

type Target struct {
	Os  string `json:"os"`
	Uri string `json:"uri"`
}

type Link struct {
	Type    string   `json:"@type"`
	Name    string   `json:"name"`
	Targets []Target `json:"targets"`
}

func HandleLambdaEvent(_ context.Context, event events.CloudWatchEvent) {
	var guardDutyEvent GuardDutyEvent
	if err := json.Unmarshal(event.Detail, &guardDutyEvent); err != nil {
		os.Exit(1)
	}
	TeamsUrl := os.Getenv("TeamsUrl")

	facts := []Fact{
		{Name: "Severity", Value: guardDutyEvent.Severity},
		{Name: "Type", Value: guardDutyEvent.Type},
		{Name: "Description", Value: guardDutyEvent.Description},
	}
	sections := []Section{{Facts: facts}}

	severity, err := strconv.ParseFloat(guardDutyEvent.Severity, 64)
	if err != nil {
		fmt.Printf("%s\n", err.Error())
		return
	}
	var color string
	if severity >= 7.0 {
		color = "#ff0000"
	} else {
		color = "#ffff00"
	}
	pipelineURL := "https://console.aws.amazon.com/guardduty/home?region=" + guardDutyEvent.Region + "#/findings?search=id=" + guardDutyEvent.Id
	targets := []Target{{Os: "default", Uri: pipelineURL}}
	links := []Link{{Type: "OpenUri", Name: "Jump To GuardDuty", Targets: targets}}

	payload, err := json.Marshal(struct {
		Summary         string    `json:"summary"`
		Type            string    `json:"@type"`
		ThemeColor      string    `json:"themeColor"`
		Title           string    `json:"title"`
		Sections        []Section `json:"sections"`
		PotentialAction []Link    `json:"potentialAction"`
	}{
		Summary:         "Summary",
		Type:            "MessageCard",
		ThemeColor:      color,
		Title:           "GuardDuty",
		Sections:        sections,
		PotentialAction: links,
	})
	if err != nil {
		fmt.Println(err)
		return
	}

	resp, err := http.Post(TeamsUrl, "application/json; charset=UTF-8", bytes.NewReader(payload))
	if err != nil {
		fmt.Println(err)
		return
	}
	defer resp.Body.Close()
	if resp.StatusCode != http.StatusOK {
		fmt.Printf("HTTP: %v\n", resp.StatusCode)
	}
}

func main() {
	lambda.Start(HandleLambdaEvent)
}
```

# Teams„Å∏„ÅÆÈÄöÁü•„ÅÆÁ¢∫Ë™ç
Lambda„Å®TeamsÈñì„ÅÆÁñéÈÄö„ÅØ„ÄÅLambda„ÅÆAWS„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„ÄÅ„ÉÜ„Çπ„Éà„Ç§„Éô„É≥„Éà„Çí‰ΩúÊàê„Åó„Äå„ÉÜ„Çπ„Éà„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åì„Å®„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇTeams„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/article-0004/lambda-test.png)

# ÊúÄÂæå„Å´
