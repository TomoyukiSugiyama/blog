---
title: "Lambda (golang)ã§OpenSearchã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®šæœŸçš„ã«åå‰è§£æ±ºã—ã€ALBã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ›´æ–°ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®ã¿ï¼‰"
emoji: "ğŸ³"
type: "tech"
topics: ["aws", "lambda", "golang", "alb", "opensearch"]
published: true
---

# åˆã‚ã«
ç”Ÿç”£æŠ€è¡“éƒ¨ã§è£½å“ã®æ¤œæŸ»å·¥ç¨‹ã‚’æ‹…å½“ã—ã¦ã„ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚å·¥å ´ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ãˆã‚‹åŒ–ã™ã‚‹ãŸã‚ã«ã€å·¥å ´ã§ä½¿ã‚ãªããªã£ãŸã‚µãƒ¼ãƒã‚’åˆ©ç”¨ã—ã¦ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã«[The Elastic Stack](https://www.elastic.co/jp/elastic-stack/)(Elasticsearchã€Kibanaã€Logstashã€Filebeatã€Metricbeat)ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚

ã—ã‹ã—ã€æœ¬æ¥­ã§ã‚ã‚‹ç”Ÿç”£æŠ€è¡“æ¥­å‹™ã®å‚ã‚‰ã§ã€ç”Ÿç”£é‡å¢—åŠ ã«ä¼´ã†ã‚µãƒ¼ãƒè² è·å¯¾å¿œã‚„æ•…éšœå¯¾å¿œã¨ã„ã£ãŸã‚µãƒ¼ãƒã®ç®¡ç†ã‚’è¡Œã†äº‹ã¯é›£ã—ã„ãŸã‚ã€AWSã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚AWSã‚’åˆ©ç”¨ã™ã‚‹ç›®çš„ã¯ç®¡ç†é¢ã®èª²é¡Œè§£æ¶ˆã ã‘ã§ãªãã€AWSã§æä¾›ã•ã‚Œã‚‹å¤šæ§˜ãªã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã‚„ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹äº‹ã«ã‚ˆã‚‹ä»–äº‹æ¥­éƒ¨ã¨ã®é€£æºã‚’è¦–é‡ã«å…¥ã‚Œã¦æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚

# AWSã§æ¤œè¨ã—ã¦ã„ã‚‹æ§‹æˆ
ä¼šç¤¾ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰[AWS Direct Connect](https://aws.amazon.com/jp/directconnect/)(å°‚ç”¨ç·šæ¥ç¶šã‚µãƒ¼ãƒ“ã‚¹)ã‚’åˆ©ç”¨ã—ã€æ¥ç¶šã—ã¦ã„ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦ä»¶ã‹ã‚‰ã€ä¼šç¤¾ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«é™å®šã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¯é…ç½®ã›ãšã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®ã¿ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ç¤¾å†…ã«é…ç½®ã—ãŸFilebeatã‹ã‚‰Fargateã§ç«‹ã¡ä¸Šã’ãŸLogstashã«ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã€Logstashã‹ã‚‰[Amazon OpenSearch Service](https://aws.amazon.com/jp/opensearch-service/)(ä»¥ä¸‹ã€OpenSearch)ã«æ¥ç¶šã—ã¾ã™ã€‚ALBã‚’OpenSearchã«ç¹‹ãã€ä¼šç¤¾ã‹ã‚‰OpenSearch Dashboardã‚’é–²è¦§å‡ºæ¥ã‚‹æ§˜ã«ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/35602d7985a2-20220327.png)

# OpenSearchã¨ALBæ¥ç¶šã«ãŠã‘ã‚‹èª²é¡Œ

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®ã¿ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹æˆã™ã‚‹ãŸã‚ã€OpenSearchã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯VPCã«å‘ã‘ã¦ã„ã¾ã™ã€‚ã“ã®è¨­å®šã§ã¯ã€OpenSearchã®ENI(Elastic Network Interface)ãŒVPCå†…ã«é…ç½®ã•ã‚Œã€VPCå†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰OpenSearchã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹äº‹ãŒå‡ºæ¥ã¾ã™ã€‚OpenSearchã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®æ§˜ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã—ã¾ã™ã€‚

`https://vpc-domain-name`

https://docs.aws.amazon.com/ja_jp/opensearch-service/latest/developerguide/vpc.html

ç¾åœ¨(2022/3/27)æ™‚ç‚¹ã§ã€ALBã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹äº‹ãŒå‡ºæ¥ãªã„ãŸã‚ã€OpenSearchã®ENIã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€OpenSearchã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã«ã€ã“ã®ã‚ˆã†ãªåˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚

> IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šæœŸçš„ã«è§£æ±ºã—ã¦å¸¸ã«æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚DNS è§£æ±ºé–“éš”ã‚’ 1 åˆ†é–“ã«è¨­å®šã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

# AWS Lambdaã‚’åˆ©ç”¨ã—ãŸå¯¾ç­–ã¨æ–¹é‡
 Lambdaã‚’åˆ©ç”¨ã—ã€1åˆ†æ¯ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®åå‰è§£æ±ºã‚’è¡Œã„ã€ALBã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šã¨ç•°ãªã‚‹å ´åˆã¯ã€å€¤ã‚’æ›´æ–°ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

1åˆ†æ¯ã®å®šæœŸå®Ÿè¡Œã«ã¯ã€Amazon EventBridge(CloudWatch Events)ã‚’åˆ©ç”¨ã—ã€Lambdaã«åˆ©ç”¨ã™ã‚‹è¨€èªã¯ã€è‡ªåˆ†ãŒä¸€ç•ªä½¿ã„ã‚„ã™ãã†ãªgolangã¨ã—ã¾ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã®ï¼’ã¤ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

* https://github.com/aws/aws-lambda-go  
Lambdaã‚’æ“ä½œã™ã‚‹ãŸã‚ã«ä½¿ç”¨
* https://github.com/aws/aws-sdk-go-v2  
ALBã‚’æ“ä½œã™ã‚‹ãŸã‚ã«ä½¿ç”¨

Lambdaã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®ã¿ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«[AWS PrivateLink](https://aws.amazon.com/jp/privatelink/?privatelink-blogs.sort-by=item.additionalFields.createdDate&privatelink-blogs.sort-order=desc)ã‚’è¨­å®šã—ã¾ã™ã€‚

# Lambda Functionã®å®Ÿè£…
å‚è€ƒå®Ÿè£…ï¼šhttps://github.com/TomoyukiSugiyama/ElasticStack/blob/main/provisioning/lambda/populate-alb-tg-with-opensearch/populate-alb-tg-with-opensearch.go

1. ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ãŸOpenSearchã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€AWS::ElasticLoadBalancingV2::LoadBalancerã®Amazon Resource Name (ä»¥ä¸‹ã€ARN)ã€AWS::ElasticLoadBalancingV2::TargetGroupã®ARNã‚’å–å¾—
2. OpenSearchã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰åå‰è§£æ±ºã—ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
3. aws-lambda-goã€aws-sdk-go-v2ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®åˆæœŸè¨­å®š
4. LoadBalancerã®ARNã‹ã‚‰LoadBalancerã‚’å–å¾—
5. TargetGroupã®ARNã‹ã‚‰TargetGroupã‚’å–å¾—
6. TargetGroupã«Opensearchã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€æ–°è¦ã«Targetã‚’ç™»éŒ²
7. ALBã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’å…ƒã«ã€ä¸è¦ã«ãªã£ãŸTargetã®ç™»éŒ²ã‚’è§£é™¤

```go:privisioning/lambda/populate-alb-tg-with-opensearch.yaml
func HandleLambdaEvent() {
	// 1. ç’°å¢ƒå¤‰æ•°å–å¾—
	domainEndpoint := os.Getenv("DomainEndpoint")
	albId := os.Getenv("AlbId")
	albTargetGroupId := os.Getenv("AlbTargetGroupId")
	fmt.Printf("GET ENV DomainEndpoint: %s AlbId: %s AlbTargetGroupId: %s\n", domainEndpoint, albId, albTargetGroupId)
	// 2. åå‰è§£æ±º
	opensearchIpAddr := ResolveIpAddress(domainEndpoint)
	fmt.Printf("GET OpensearchIpAddressddress: %s\n", opensearchIpAddr)
	// 3. åˆæœŸè¨­å®š
	svc := Init()
	// 4. æŒ‡å®šã—ãŸLoadbalancerã‚’å–å¾—
	lb := GetSpecifiedLoadbalancer(svc, albId)
	fmt.Printf("GET LoadbalancerName: %s LoadbalancerArn: %s\n", *lb.LoadBalancerName, *lb.LoadBalancerArn)
	// 5. æŒ‡å®šã—ãŸLoadbalancerã®TargetGroupã‚’å–å¾—
	tg := GetSpecifiedTargetGroup(svc, lb, albTargetGroupId)
	fmt.Printf("GET TargetGroupName: %s TargetGroupArn: %s\n", *tg.TargetGroupName, *tg.TargetGroupArn)
	// 6. TargetGroupã«Targetã®ç™»éŒ²
	if !HasTarget(svc, tg, opensearchIpAddr) {
		const httpsPort = 443
		RegisterSpecifiedTarget(svc, tg, opensearchIpAddr, httpsPort)
		fmt.Println("REGISTER")
	}
	// 7. UnheltyãªTargetã®ç™»éŒ²è§£é™¤
	DeregisterUnheltyTargets(svc, tg)
}
```

Cloudformationã¯ã€ä¸‹è¨˜ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚S3Bucketã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ALBã®ARNã€TargetGroupã®ARNã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚IAMãƒ­ãƒ¼ãƒ«ã®ãƒãƒªã‚·ãƒ¼ã«ã¯ã€VPCå†…ã§Lambdaã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®`AWSLambdaVPCAccessExecutionRole`ã€S3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ç‚ºã®`AmazonS3ReadOnlyAccess`ã€LoadBalancerã«é–¢é€£ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚


```yaml:privisioning/cfn/lambda.yaml
  Function:
    Type: AWS::Lambda::Function
    Properties:
      Handler: populate-alb-tg-with-opensearch
      Role: !GetAtt LambdaRole.Arn
      Code:
        S3Bucket: lambda-XXXXXXXXXXXXXXXXXXX-artifact
        S3Key: populate-alb-tg-with-opensearch.zip
      Runtime: go1.x
      Timeout: 5
      TracingConfig:
        Mode: Active
      VpcConfig:
        SecurityGroupIds:
          - Ref: SecurityGroupId
        SubnetIds: !Split [",", !Ref SubnetIds]
      Environment:
        Variables:
          DomainEndpoint: !Ref DomainEndpoint
          AlbId: !Ref AlbId
          AlbTargetGroupId: !Ref AlbTargetGroupId

  LambdaRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Condition: {}
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      Policies:
        - PolicyName: FIoTElasticLoadBalancingAccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "elasticloadbalancing:DescribeLoadBalancers"
                  - "elasticloadbalancing:DescribeTargetHealth"
                  - "elasticloadbalancing:DescribeTargetGroups"
                  - "elasticloadbalancing:RegisterTargets"
                  - "elasticloadbalancing:DeregisterTargets"
                Resource: "*"
      Tags:
        - Key: com.trim.f-iot
          Value: lambda
    Type: AWS::IAM::Role
```

# EventBridgeã®è¨­å®š
å‚è€ƒå®Ÿè£…ï¼šhttps://github.com/TomoyukiSugiyama/ElasticStack/blob/main/provisioning/cfn/lambda.yaml

ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒ«ã¯ã€cronå½¢å¼ã§è¨˜è¿°ã—ã€1åˆ†æ¯ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†æŒ‡å®šã—ã¾ã™ã€‚AWS::Lambda::Permissionã«EventBridgeã‹ã‚‰ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚’è¨±å¯ã—ã¾ã™ã€‚

```yaml:privisioning/cfn/lambda.yaml
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: pupulate atb target with opensearch
      Name: populate-alb-tg-with-opensearch-rule
      ScheduleExpression: cron(* * * * ? *)
      State: ENABLED
      Targets:
        - Arn: !GetAtt Function.Arn
          Id: lambda

  EventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref Function
      Principal: events.amazonaws.com
      SourceAccount: !Ref AWS::AccountId
      SourceArn: !GetAtt EventRule.Arn
```

# PrivateLinkã®è¨­å®š
å‚è€ƒå®Ÿè£…ï¼šhttps://github.com/TomoyukiSugiyama/ElasticStack/blob/main/provisioning/cfn/vpc-endpoint.yaml

ä»¥ä¸‹ã®PrivateLinkã‚’è¨­å®šã—ã¾ã™ã€‚
* Lambdaã‹ã‚‰S3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(Gatewayå‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ãŒã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚‚è¨­å®šå¯èƒ½ã§ã™ã€‚)
* Lambdaã®Logã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
* Lambdaã‹ã‚‰ALBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ


```yaml:provisioning/cfn/vpc-endpoint.yaml
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      VpcId: !Ref VpcId
      RouteTableIds:
        - !Ref PrivateRouteTableId

  LogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      VpcId: !Ref VpcId
      SubnetIds: !Split [",", !Ref SubnetIds]
      SecurityGroupIds:
        - !Ref SecurityGroupId

  ElasticLoadBalancingEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.elasticloadbalancing"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      VpcId: !Ref VpcId
      SubnetIds: !Split [",", !Ref SubnetIds]
      SecurityGroupIds:
        - !Ref SecurityGroupId
```

# å‹•ä½œç¢ºèª
OpenSearchã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’ç·¨é›†ã—ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¼·åˆ¶çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/cf3be8162da3-20220327.png)

æ–°ã—ã„ãƒ«ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹ã¨ã€Lambdaã§æ¤œçŸ¥ã—ã¦ALBã®Targetã‚’è¿½åŠ ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/225432cf2313-20220327.png)

OpenSearchãŒå¤ã„ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯ã€Unhealtyã¨ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/584b1a69c493-20220327.png)

Lambdaã§UnhealtyãªTargetã‚’æ¤œçŸ¥ã—ã¦ã€Targetã®ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3824be50b1ef-20220327.png)

TargetGroupã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã™ã‚‹ã¨ã€æƒ³å®šé€šã‚Šã®å‹•ãã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8af64c0bccc6-20220327.png)

ãƒ­ã‚°ã§ç¢ºèªã™ã‚‹ã¨ã€`REGISTER`ã€`DEREGISTER`ãŒä¸€å›ãšã¤å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```log
START RequestId: f100a28d-367f-4d89-ad45-ebf6b36867ad Version: $LATEST
GET OpensearchIpAddressddress: 172.31.35.214
GET LoadbalancerName: f-iot-alb LoadbalancerArn: arn:aws:elasticloadbalancing:ap-northeast-1:XXXXXXXXXXXX:loadbalancer/app/f-iot-alb/a7e46ad189fb1a72
GET TargetGroupName: f-iot-alb-tg TargetGroupArn: arn:aws:elasticloadbalancing:ap-northeast-1:XXXXXXXXXXXX:targetgroup/f-iot-alb-tg/4ab4dba084c2bb5c
REGISTER
END RequestId: f100a28d-367f-4d89-ad45-ebf6b36867ad
:
:
START RequestId: f55b9976-fd87-4e26-acfa-e75ae4ed4d76 Version: $LATEST
GET OpensearchIpAddressddress: 172.31.35.214
GET LoadbalancerName: f-iot-alb LoadbalancerArn: arn:aws:elasticloadbalancing:ap-northeast-1:XXXXXXXXXXXX:loadbalancer/app/f-iot-alb/a7e46ad189fb1a72
GET TargetGroupName: f-iot-alb-tg TargetGroupArn: arn:aws:elasticloadbalancing:ap-northeast-1:XXXXXXXXXXXX:targetgroup/f-iot-alb-tg/4ab4dba084c2bb5c
DEREGISTER UnhealtyTarget.Id: 172.31.19.18
END RequestId: f55b9976-fd87-4e26-acfa-e75ae4ed4d76
```

# æœ€å¾Œã«
AWSã¯å§‹ã‚ãŸã°ã‹ã‚Šã®åˆå¿ƒè€…ã§ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç³»ã®è·å ´ã®ãŸã‚ã€ä¸€äººã§è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰AWSã‚’ä½¿ã£ã¦ã„ã‚‹çŠ¶æ³ã§ã™ã€‚Lambdaã‚‚åˆã‚ã¦åˆ©ç”¨ã—ã¾ã—ãŸãŒã€ãªã‚“ã¨ã‹æƒ³å®šé€šã‚Šã«å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä¸é©åˆ‡ãªéƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ã”æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹ç¯‰è‡ªä½“ãŒç´ äººã®ãŸã‚ã€ã„ã‚ã‚“ãªã¨ã“ã‚ã§è‹¦æˆ¦ã—ã¦ã„ã¾ã™ã€‚ä»Šå¾Œã¯ã€åˆã‚ã¦ä½¿ã†AWSã‚µãƒ¼ãƒ“ã‚¹(AWS DirectConnectã€Fargate)ã§è‹¦åŠ´ã—ãŸã“ã¨ãªã©ã‚’ç™ºä¿¡ã—ã¦ã„ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚

# ã”å‚è€ƒ

https://aws.amazon.com/jp/blogs/networking-and-content-delivery/using-aws-lambda-to-enable-static-ip-addresses-for-application-load-balancers/
